#!/bin/bash
# $Id: chklnks,v 1.119 2016/04/21 08:52:57 fulford Exp fulford $
# $Source: /src/merlin/usr/local/etc/RCS/chklnks,v $
# $Revision: 1.119 $
# Author C W Fulford.
# Copyright 2014 (c) C W Fulford.
# Licensed for public use under the LGPL, .
# For assistance contact fulford@fulford.net 0709 229 5385
########################################################################
cmd=`basename $0`
syntax="$cmd [-d] [[-h <hostid> [-r] [-v] [[-a]|[<dir_name> <dir_name> ...]]]|[-V]"
while [ $# -gt 0 ] ;do
	case $1 in 
		-a) all=0;shift;;
		-d) set -x;debug=:;shift;;
		-h) hostid=$2;shift 2;;
		-r) action=delete;shift;;
		-v) verbose=0;shift;;
		-V) echo "$cmd $Revision: 1.119 $ $Date: 2016/04/21 08:52:57 $"|awk '{print $1,$3,$6}';exit;;  
		 /*) paths="$paths $1";shift;;
	 	*) echo "$syntax" >&2;exit;;
	esac
done
action=${action:-"echo"}
all=${all:=1}
[ $all -eq 0  -a "$paths" ] &&{
	echo "$cmd: can't specify directories with the -a option" >&2
	echo "syntax: $syntax" >&2
	exit 1
}
tmounts=/tmp/mounts-$$
verbose=${verbose:-1}
if [ "$hostid" ]; then
	if nc -zw 2 $hostid 22 ;then
		rchk="ssh $hostid"
		ssh $hostid "sudo cat /etc/mtab" >$tmounts
	else	
		echo "$cmd: ssh not available on $hostid" >&2
		exit 1
	fi
else
	cat /etc/mtab >$tmounts
fi
		
if [ $all -eq 0 ];then
	paths=`cat $tmounts|
		egrep -v " ro |,bind| nfsd| nfs |gvfsd-fuse"|
			awk '{print "$2 "}'
	`
fi
paths=${paths:-"./"}
[ "$verbose" ] &&{
	echo "$cmd: paths = "$paths
}
exit

for d in $paths;do
	if [ $verbose ];then
		echo "$cmd: checking directory $d"
	fi
	targets=`$rchk "sudo find -L $d -xdev -type l -print"`
	[ -n "$targets" ] &&{  
		if [ $action == "delete" ] ;then
			for t in $targets ;do
				$rchk "sudo rm $t" 
				if [ $? -eq 0 -a $verbose ];then
					echo "$cmd: $t dead link removed" >&2
				fi
			done
		else
			for t in $targets ;do
				$action "$cmd: found dead link $t" >&2
			done
		fi	
	}	
done
sudo rm $tdf $tmounts
